<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2563eb">
    <title>Trova la Mia Auto</title>
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlRyb3ZhIGxhIE1pYSBBdXRvIiwKICAic2hvcnRfbmFtZSI6ICJQYXJjaGVnZ2lvIiwKICAic3RhcnRfdXJsIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmZmZmZmYiLAogICJ0aGVtZV9jb2xvciI6ICIjMjU2M2ViIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01DOXpkbWNpSUhkcFpIUm9QU0l4T1RJaUlHaGxhV2RvZEQwaU1Ua3lJaUI5UEhKbFkzUWdlRDBpTWpBaUlIazlJakl3SWlCM2FXUjBhRDBpTVRVeUlpQm9aV2xuYUhROUlqRTFNaUlnY25nOUlqRXlJaUJtYVd4c1BTSWpNalUyTTJWaUlpOCtQSEJoZEdnZ1pEMGlUVGMySURRNFF6YzJJRFEzTGpRMk5DQTNOaTQxTXpZZ05EZ2dOemNnTkRoRE56Y3VOVFEySURRNElEYzRJRFEzTGpRMk5DQTNPQ0EwTmxNNE15NDBOallnTkRRZ09EUWdORFJETWpRZ05EUWdNVFlnTmpJZ01UWWdPRFpETVRZZ01URXdJREkwSURFek1pQXpNaUF4TXpKV01UTTJRek15SURFMk1DQXhNVFlnTVRneUlERXhOaUF4T1RKRE1URTJJREl3TWlBeU5DQXlNakFnTXpJZ01qSXdWakUwTkVNek1pQXhORFFnTlRRZ01USTRMalUxTmlBMU5DQXhNVEpUTnpZZ09UWWdOellnTkRoYWJUQXRNalJETmpjdU1qTXlJREkwSURZd0lETXlMamN3TmlBMk1DQTBNbE0yTUNBMU1TNHlPVFFnTmpjdU1qTXlJRFl3SURjMklEWXdRemcwTGpreU9DQTJNQ0E1TmlBMU1TNHlPVFFnT1RZZ05ESlRPVFlnTXpJdU56QTJJRGczTGpJek1pQXlOQ0EzTmlBeU5Gb2lJR1pwYkd3OUlpTm1abVptWm1ZaUx6NDhMMk5uUGc9PSIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01DOXpkbWNpSUhkcFpIUm9QU0kxTVRJaUlHaGxhV2RvZEQwaU5URXlJaUI5UEhKbFkzUWdlRDBpTlRBaUlIazlJalV3SWlCM2FXUjBhRDBpTkRFeUlpQm9aV2xuYUhROUlqUXhNaUlnY25nOUlqTXlJaUJtYVd4c1BTSWpNalUyTTJWaUlpOCtQSEJoZEdnZ1pEMGlUVEl3TVNBMU9FOTFNU0F4UVRFd01DQXhNREFnTUNBd0lERWdNakF4SURFME0xWXhNelZETWpBeElERTFNQzR5TnpnZ01UZzRMalF5TkNBeE9UQWdNVFl5SURFNU1FZ3hOVEJETVRFeExqVTNOaUF4T1RBZ056RWdNVFV3TGpJM09DQTNNU0F4TXpWV05UbEROekVnTkRNdU56SXlJREV4TVM0MU56WWdNeklnTVRVd0lETXlTREl3TTBNeU1qUXVOakkwSURNeUlESXhPU0EwTXk0M01qSWdNakU1SURVNVZqRTBNME15TVRrZ01UVXdMakkzT0NBeU1qUXVOakkwSURFNU1DQXlNRE1nTVRrd2VpSWdabWxzYkQwaUkyWm1abVptWmlJdlBqd3ZjM1puUGc9PSIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0KICBdCn0=">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .logo {
            width: 120px;
            height: 120px;
            margin: 0 auto;
            background: #2563eb;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(37, 99, 235, 0.3);
        }

        .logo svg {
            width: 80px;
            height: 80px;
        }

        h1 {
            text-align: center;
            color: #1e293b;
            font-size: 24px;
            margin-top: 10px;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        button {
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-save {
            background: #10b981;
            color: white;
        }

        .btn-save:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }

        .btn-retrieve {
            background: #3b82f6;
            color: white;
        }

        .btn-retrieve:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }

        .info-box {
            background: #f1f5f9;
            padding: 20px;
            border-radius: 12px;
            margin-top: 10px;
            display: none;
        }

        .info-box.show {
            display: block;
        }

        .info-box h3 {
            color: #1e293b;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .info-item {
            margin: 8px 0;
            color: #475569;
            font-size: 14px;
            line-height: 1.6;
        }

        .info-item strong {
            color: #1e293b;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-content h2 {
            color: #1e293b;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .modal-content p {
            color: #475569;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 12px;
        }

        .btn-cancel {
            background: #94a3b8;
            color: white;
        }

        .btn-confirm {
            background: #10b981;
            color: white;
        }

        .status {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
            display: none;
        }

        .status.show {
            display: block;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .status.info {
            background: #dbeafe;
            color: #1e40af;
        }

        @media (max-width: 480px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 20px;
            }

            .logo {
                width: 100px;
                height: 100px;
            }

            .logo svg {
                width: 60px;
                height: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 192">
                <rect x="20" y="20" width="152" height="152" rx="12" fill="#2563eb"/>
                <path d="M76 48C76 47.464 76.536 48 77 48C77.546 48 78 47.464 78 46S83.466 44 84 44C24 44 16 62 16 86C16 110 24 132 32 132V136C32 160 116 182 116 192C116 202 24 220 32 220V144C32 144 54 128.556 54 112S76 96 76 48Zm0-24C67.232 24 60 32.706 60 42S60 51.294 67.232 60 76 60C84.928 60 96 51.294 96 42S96 32.706 84.928 24 76 24Z" fill="#ffffff"/>
            </svg>
        </div>
        
        <h1>Trova la Mia Auto</h1>
        
        <div class="button-group">
            <button class="btn-save" onclick="confirmSavePosition()">
                <span>üìç</span>
                <span>Salva Posizione</span>
            </button>
            
            <button class="btn-retrieve" onclick="retrievePosition()">
                <span>üîç</span>
                <span>Trova la Mia Auto</span>
            </button>
        </div>

        <div class="status" id="status"></div>
        
        <div class="info-box" id="infoBox">
            <h3>Posizione Salvata</h3>
            <div id="infoContent"></div>
        </div>
    </div>

    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <h2>Conferma Salvataggio</h2>
            <p>Vuoi salvare la posizione attuale del tuo veicolo? Questo sovrascriver√† la posizione precedente.</p>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeModal()">Annulla</button>
                <button class="btn-confirm" onclick="savePosition()">Conferma</button>
            </div>
        </div>
    </div>

    <script>
        let db;

        // Inizializza IndexedDB
        function initDB() {
            const request = indexedDB.open('ParcheggioAutoDB', 1);
            
            request.onerror = () => {
                showStatus('Errore nell\'inizializzazione del database', 'error');
            };
            
            request.onsuccess = (e) => {
                db = e.target.result;
            };
            
            request.onupgradeneeded = (e) => {
                db = e.target.result;
                if (!db.objectStoreNames.contains('posizione_auto')) {
                    db.createObjectStore('posizione_auto', { keyPath: 'id' });
                }
            };
        }

        // Registra Service Worker per PWA
        if ('serviceWorker' in navigator) {
            const swCode = `
                self.addEventListener('install', (e) => {
                    e.waitUntil(
                        caches.open('parcheggio-v1').then((cache) => {
                            return cache.addAll(['/']);
                        })
                    );
                });

                self.addEventListener('fetch', (e) => {
                    e.respondWith(
                        caches.match(e.request).then((response) => {
                            return response || fetch(e.request);
                        })
                    );
                });
            `;
            
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl);
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status show ${type}`;
            setTimeout(() => {
                status.classList.remove('show');
            }, 3000);
        }

        function confirmSavePosition() {
            document.getElementById('confirmModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('confirmModal').classList.remove('show');
        }

        async function savePosition() {
            closeModal();
            showStatus('Ottenendo la posizione...', 'info');

            if (!navigator.geolocation) {
                showStatus('Geolocalizzazione non supportata', 'error');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const now = new Date();
                    
                    let address = 'Indirizzo non disponibile';
                    
                    // Prova a ottenere l'indirizzo tramite reverse geocoding
                    try {
                        const response = await fetch(
                            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`
                        );
                        const data = await response.json();
                        
                        if (data.address) {
                            const addr = data.address;
                            const street = addr.road || addr.street || '';
                            const number = addr.house_number || '';
                            const city = addr.city || addr.town || addr.village || '';
                            
                            address = `${street} ${number}, ${city}`.trim();
                        }
                    } catch (error) {
                        console.error('Errore nel recupero dell\'indirizzo:', error);
                    }

                    const positionData = {
                        id: 1,
                        latitude: lat,
                        longitude: lon,
                        data: now.toLocaleDateString('it-IT'),
                        ora: now.toLocaleTimeString('it-IT'),
                        indirizzo: address,
                        timestamp: now.getTime()
                    };

                    const transaction = db.transaction(['posizione_auto'], 'readwrite');
                    const store = transaction.objectStore('posizione_auto');
                    
                    store.put(positionData);
                    
                    transaction.oncomplete = () => {
                        showStatus('Posizione salvata con successo!', 'success');
                        displayPosition(positionData);
                    };
                    
                    transaction.onerror = () => {
                        showStatus('Errore nel salvataggio', 'error');
                    };
                },
                (error) => {
                    let errorMsg = 'Errore nella geolocalizzazione';
                    if (error.code === error.PERMISSION_DENIED) {
                        errorMsg = 'Permesso geolocalizzazione negato';
                    }
                    showStatus(errorMsg, 'error');
                }
            );
        }

        function retrievePosition() {
            const transaction = db.transaction(['posizione_auto'], 'readonly');
            const store = transaction.objectStore('posizione_auto');
            const request = store.get(1);
            
            request.onsuccess = (e) => {
                const data = e.target.result;
                if (data) {
                    displayPosition(data);
                    showStatus('Posizione recuperata!', 'success');
                    
                    // Apri Google Maps con la posizione
                    const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${data.latitude},${data.longitude}`;
                    window.open(mapsUrl, '_blank');
                } else {
                    showStatus('Nessuna posizione salvata', 'error');
                    document.getElementById('infoBox').classList.remove('show');
                }
            };
            
            request.onerror = () => {
                showStatus('Errore nel recupero', 'error');
            };
        }

        function displayPosition(data) {
            const infoBox = document.getElementById('infoBox');
            const infoContent = document.getElementById('infoContent');
            
            infoContent.innerHTML = `
                <div class="info-item"><strong>üìÖ Data:</strong> ${data.data}</div>
                <div class="info-item"><strong>üïê Ora:</strong> ${data.ora}</div>
                <div class="info-item"><strong>üìç Coordinate:</strong> ${data.latitude.toFixed(6)}, ${data.longitude.toFixed(6)}</div>
                <div class="info-item"><strong>üè† Indirizzo:</strong> ${data.indirizzo}</div>
            `;
            
            infoBox.classList.add('show');
        }

        // Inizializza l'app
        initDB();
    </script>
</body>
</html>
